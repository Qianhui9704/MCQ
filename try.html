<script type="text/javascript">
    var result = document.getElementById("result");
    var file = document.getElementById("file");
    var doubleconditions = 0;
    window.onload = function () {
        document.getElementById('ti').style.display = "none";
        document.getElementById('intro').style.display = "none";
        document.getElementById('ready').style.display = "none";


    }
//判断浏览器是否支持FileReader接口  
    if (typeof FileReader == 'undefined') {
        result.InnerHTML = "<p>你的浏览器不支持FileReader接口！</p>";
        //使选择控件不可操作  
        file.setAttribute("disabled", "disabled");
    }

    function readAsDataURL() {
        //检验是否为图像文件  
        var file = document.getElementById("file").files[0];
        if (!/image\/\w+/.test(file.type)) {
            alert("看清楚，这个需要图片！");
            return false;
        }
        var reader = new FileReader();
        //将文件以Data URL形式读入页面  
        reader.readAsDataURL(file);
        reader.onload = function (e) {
            var result = document.getElementById("result");
            //显示文件  
            result.innerHTML = '<img src="' + this.result + '" alt="" />';
        }
    }

    function readAsBinaryString() {
        var file = document.getElementById("file").files[0];
        var reader = new FileReader();
        //将文件以二进制形式读入页面  
        reader.readAsBinaryString(file);
        reader.onload = function (f) {
            var result = document.getElementById("result");
            //显示文件  
            result.innerHTML = this.result;
        }
    }


    var answers = new Array();
    var questions = new Array();

    function readAsTextA() {
        doubleconditions++;
        var c1 = new Array();
        var c2 = new Array();
        var c3 = new Array();
        var c4 = new Array();
        var c5 = new Array();
        var c6 = new Array();
        var file = document.getElementById("file").files[0];
        var reader = new FileReader();
        //将文件以文本形式读入页面  
        reader.readAsText(file);
        reader.onload = function (f) {
            var result = document.getElementById("result");
            var data = this.result;
            data = data.split("\n");
            for (var n = 1; n < data.length; n++) {
                //var theline = data[n].split(",(?=(?:[^\"]*\"[^\"]*\")*[^\"]*$)", -1);
                var theline = data[n].split(/,(?=(?:[^\"]*\"[^\"]*\")*(?![^\"]*\"))/);
                c1.push(theline[0]);
                c2.push(theline[1]);
                c3.push(theline[2]);
                c4.push(theline[3]);
                c5.push(theline[4]);
                c6.push(theline[5]);
            }
            for (var n = 0; n < c1.length; n++) {
                var ananswer = new Array();
                ananswer.push(c1[n]);
                ananswer.push(c2[n]);
                ananswer.push(c3[n]);
                ananswer.push(c4[n]);
                ananswer.push(c5[n]);
                ananswer.push(c6[n]);
                answers.push(ananswer);
            }
            alert('answer input completed');
//            alert(answers[44][0]);
//            alert(answers[1][0]);


            //显示文件  
            result.innerHTML = this.result;
            if (doubleconditions == 2) {
                document.getElementById('intro').style.display = "";
                document.getElementById('ready').style.display = "";
            }

        }
    }

    function readAsTextQ() {
        doubleconditions++;
        var c1 = new Array();
        var c2 = new Array();
        var c3 = new Array();
        var c4 = new Array();
        var file = document.getElementById("file").files[0];
        var reader = new FileReader();
        //将文件以文本形式读入页面  
        reader.readAsText(file);
        reader.onload = function (f) {
            var result = document.getElementById("result");
            var data = this.result;
            data = data.split("\n");
            for (var n = 1; n < data.length; n++) {
                var theline = data[n].split(/,(?=(?:[^\"]*\"[^\"]*\")*(?![^\"]*\"))/);
                c1.push(theline[0]);
                c2.push(theline[1]);
                c3.push(theline[2]);
                c4.push(theline[3]);
            }

            //alert(c3[0]);
//        alert(c2[1]);
//        alert(c3[2]);
            for (var n = 0; n < c1.length; n++) {
                var aquestion = new Array();
                aquestion.push(c1[n]);
                aquestion.push(c2[n]);
                aquestion.push(c3[n]);
                aquestion.push(c4[n]);
                questions.push(aquestion);
            }
            alert('question input completed');
            alert(questions[0][3]);
            //显示文件  
            result.innerHTML = questions[0];
            if (doubleconditions == 2) {
                document.getElementById('intro').style.display = "";
                document.getElementById('ready').style.display = "";
            }

        }
    }
    var imajiti = 1;
    function begin() {

        document.getElementById('intro').style.display = "none";
        document.getElementById('ready').style.display = "none";
        document.getElementById('ti').style.display = "";
        for (var n = 0; n < answers.length; n++) {
            var duidu = answers[n][2] * 0.7 + 0.2 * answers[n][4] / 10 + 0.1 * answers[n][5] / 10;
            answers[n].push(duidu);

        }
        alert(answers[0][6]);
        if (questions[imajiti - 1][0].slice(0, 2) == "MC") {
            alert('here');
            var imacorrect = new Array();
            var cuofa = new Array();
            var imawrong = new Map();
            for (var n = 0; n < answers.length; n++) {
                if (answers[n][1] == questions[imajiti-1][1]) {
                    if (answers[n][3] == questions[imajiti-1][3]&& answers[n][6]>0.5) {
                        imacorrect.push(answers[n]);
                    } else {
                        var xinde = true;
                        for (var m = 0; m < cuofa.length; m++) {

                            if (answers[n][3] == cuofa[m]) {
                                xinde = false;
                            }

                        }
                        if (xinde == true) {
                            cuofa.push(answers[n][3]);
                        }

                    }
                }
            }
            for (var n = 0; n < cuofa.length; n++) {
                var cuowujituan = new Array();
                imawrong.set(cuofa[n], cuowujituan);

            }
            for (var n = 0; n < answers.length; n++) {
                if (answers[n][1] == questions[imajiti-1][1]) {
                    for (var m = 0; m < cuofa.length; m++) {
                        if (answers[n][3] == cuofa[m]) {
                            imawrong.get(cuofa[m]).push(answers[n]);
                        }
                    }
                }

            }
            console.log(imawrong.keys());
             //alert(cuofa);
             var quanxuanze = new Array();
             var copy = new Map();
             deepcopymap(copy,imawrong);
             var jishi=0;
             while(jishi<3)
             {jishi++;
             var xuanze= new Array();
             while(xuanze.length<3){
                 var temp = xuanze.length;
                 alert("xuanzechang "+xuanze.length);
                 console.log(imawrong.keys());
                 for(var key of imawrong.keys()){
                     alert('gogogo');
                     if(imawrong.get(key).length!=0){
                     var n=randomNum(0,imawrong.get(key).length-1);
                     alert(n);
                     alert("This is pushed: "+imawrong.get(key)[n]);
                     xuanze.push(imawrong.get(key)[n].concat());
                     
                     Object.assign(imawrong.get(key)[n],imawrong.get(key)[imawrong.get(key).length-1]);
                     
                     imawrong.get(key).pop();
                     
                     
                     alert("the lenght is "+imawrong.get(key).length);}
                 }
                 if(xuanze.length==temp){
                     alert("not enought");
                     deepcopymap(imawrong,copy);
                     
                 }
             }
             console.log(xuanze);
             quanxuanze.push(xuanze);
             alert("a question pushed");
         }
            var usedn = new Array();
            var quanzhengque = new Array();
            for(var m=0;m<quanxuanze.length;m++){
                var nqualified=false;
                while(nqualified==false){
                nqualified=true;
                var n=randomNum(0,imacorrect.length-1);
                for(var shu of usedn){if(n==shu){nqualified=false}}}
                quanzhengque.push(imacorrect[n]);
                
                usedn.push(n);
            }
            usedn = [];
            console.log(quanzhengque);
            console.log(quanxuanze);
            var diffi = new Map();
            for(var n=0;n<quanxuanze.length;n++){
                var thisdiff = (1/quanzhengque[n][6]-quanxuanze[n][0][6])+(quanzhengque[n][6]-quanxuanze[n][1][6])+(quanzhengque[n][6]-quanxuanze[n][2][6]);
                diffi.set(n,thisdiff);
                
            }
            var simpletohard = [...diffi.entries()].sort((a,b) => a[1] > b[1]).map(x => x[0]);
            alert(simpletohard[0]+","+simpletohard[1]+","+diffi.get(simpletohard[0])+","+diffi.get(simpletohard[1]))


        }

    }
    function deepcopymap(xin,yuan){
        
        for(var key of yuan.keys()){
            xin.set(key, yuan.get(key).concat());
        }
        alert("copy complete");
    }
    function randomNum(minNum,maxNum){ 
    switch(arguments.length){ 
        case 1: 
            return parseInt(Math.random()*minNum+1,10); 
        break; 
        case 2: 
            return parseInt(Math.random()*(maxNum-minNum+1)+minNum,10); 
        break; 
            default: 
                return 0; 
            break; 
    } 
} 
//    function submit() {
//        var a;
//        a = $('input:radio[name="9"]:checked').val();
//        if (a === undefined) {
//            alert("input something, ok?");
//            return undefined;
//        }
//        document.getElementById('bt1').style.display = "";
//        document.getElementById('bt3').style.display = "";
//        if (a == answer[quesn]) {
//            document.getElementById('correct').innerHTML = "Correct!";
//            conum++;
//        } else {
//            document.getElementById('correct').innerHTML = "Not Correct, you may read the explanation and try again";
//        }
//        document.getElementById('explain').innerHTML = explain[quesn];
//    }


</script>  
<p>  
    <label>请选择一个文件：</label>  
    <input type="file" id="file" />  
    <input type="button" value="读取图像" onclick="readAsDataURL()" />  
    <input type="button" value="读取二进制数据" onclick="readAsBinaryString()" />  
    <input type="button" value="read as answers" onclick="readAsTextA()" />  
    <input type="button" value="read as questions" onclick="readAsTextQ()" />  
</p>  
<p id="intro">as you have provided all the data for answers and questions, brand new assessment is ready for you, click start to begin practice</p>
<button type="button" onclick="begin()" id='ready'>start</button>
<div id='ti'>
    <p id="ques"></p>
    <p id='opt1'>1</p><input type="radio"  name="9" value="a" />
    <p id='opt2'>2</p><input type="radio"  name="9" value="b" />
    <p id='opt3'>3</p><input type="radio"  name="9" value="c" />
    <p id='opt4'>4</p><input type="radio"  name="9" value="d" />
    <p id="correct"></p>

    <button type="button" onclick="retake()" id='bt1'>retake</button>
    <button type="button" onclick="submit()" id='bt2'>submit</button>
    <button type="button" onclick="next()" id='bt3'>next</button>
</div>

<div id="result" name="result"></div>